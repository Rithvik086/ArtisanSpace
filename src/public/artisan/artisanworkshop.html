<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WorkShops</title>
  <link rel="stylesheet" href="/navbar2.css" />
  <link rel="stylesheet" href="/footer.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #3a6ea5;
      --secondary-color: #ff6b6b;
      --background-color: #f8f9fa;
      --card-background: #ffffff;
      --text-color: #333333;
      --border-color: #e0e0e0;
      --success-color: #28a745;
      --header-bg: #f2f6fa;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
      padding: 20px 0;
      border-bottom: 1px solid var(--border-color);
    }

    header h1 {
      color: var(--primary-color);
      margin-bottom: 10px;
    }

    .workshops-section {
      margin-bottom: 40px;
    }

    .workshops-section h2 {
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--primary-color);
      color: black;
    }

    .workshops-table {
      width: 100%;
      border-collapse: collapse;
      background-color: var(--card-background);
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
      overflow: hidden;
    }

    .workshops-table th {
      background-color: var(--header-bg);
      color: var(--primary-color);
      font-weight: bold;
      text-align: left;
      padding: 15px;
      border-bottom: 2px solid var(--primary-color);
    }

    .workshops-table td {
      padding: 12px 15px;
      border-bottom: 1px solid var(--border-color);
      vertical-align: middle;
    }

    .workshops-table tr:last-child td {
      border-bottom: none;
    }

    .workshops-table tr:hover {
      background-color: rgba(58, 110, 165, 0.05);
    }

    .workshop-description {
      max-width: 250px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #666;
    }

    .accept-btn {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .accept-btn:hover {
      background-color: #218838;
    }

    .remove-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .remove-btn:hover {
      background-color: #c82333;
    }

    .status-badge {
      display: inline-block;
      background-color: var(--success-color);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      background-color: var(--card-background);
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 768px) {
      .workshops-table {
        display: block;
        overflow-x: auto;
      }

      .container {
        padding: 10px;
      }
    }
  </style>
</head>

<body>
  <div id="navbar-placeholder"></div>
  <main class="container">
    <section class="workshops-section">
      <h2>Available Workshops</h2>
      <div id="availableWorkshopsContainer">
        <div id="available-loading" class="loading">Loading available workshops...</div>
        <table id="availableTable" class="workshops-table" style="display:none;">
          <thead>
            <tr>
              <th>Workshop Title</th>
              <th>Description</th>
              <th>Client</th>
              <th>Date</th>
              <th>Time</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="availableBody"></tbody>
        </table>
      </div>
    </section>

    <section class="workshops-section">
      <h2>Accepted Workshops</h2>
      <div id="acceptedWorkshopsContainer">
        <div id="accepted-loading" class="loading">Loading accepted workshops...</div>
        <table id="acceptedTable" class="workshops-table" style="display:none;">
          <thead>
            <tr>
              <th>Status</th>
              <th>Workshop Title</th>
              <th>Description</th>
              <th>Client Info</th>
              <th>Date & Time</th>
              <th>Accepted On</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="acceptedBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <div id="footer-placeholder"></div>

  <script>
    // Helper to fetch JSON and handle errors
    async function fetchJson(url, options) {
      try {
        const res = await fetch(url, options);
        if (!res.ok) throw new Error('Network response was not ok');
        return await res.json();
      } catch (err) {
        console.error('Fetch error', url, err);
        return null;
      }
    }

    function createNavbar(role) {
      return `
        <header>
          <div class="header-container2">
            <div class="logonav2">ArtisanSpace</div>
            <nav class="nav2">
              <ul class="nav2ul">
                <li><a href="/artisan/">Dashboard</a></li>
                <li><a href="/artisan/listings">Listings</a></li>
                <li><a href="/artisan/workshops">Workshops</a></li>
                <li><a href="/artisan/customrequests">Custom Requests</a></li>
                <li class="dropdown">
                  <i class="fa-solid fa-bars fa-lg"></i>
                  <div class="dropdown-menu">
                    <a href="/artisan/settings" class="dropdown-item settings-btn">
                      <i class="fa-solid fa-gear"></i>
                      <p>Settings</p>
                    </a>
                    <a href="/logout" class="dropdown-item logout-btn">
                      <i class="fa-solid fa-right-from-bracket"></i>
                      <p>Logout</p>
                    </a>
                  </div>
                </li>
              </ul>
            </nav>
          </div>
        </header>
      `;
    }

    function createFooter(role) {
      const showContactAndSupport = role === 'customer' || role === 'artisan';
      return `
        <footer class="footer">
          <div class="topfooter">
            <div class="topfooter1">
              <p class="logop">AS</p>
              <p>
                It is a long established fact that a reader will be distracted by
                the readable content of a page when looking at its layout.
              </p>
            </div>
            <div class="footerhelp">
              <p class="help">Help</p>
              <a href="/aboutus" style="text-decoration: none; color: black">
                <p>AboutUs</p>
              </a>
              ${showContactAndSupport ? `
                <a href="/contactus" style="text-decoration: none; color: black;">
                  <p>Contact</p>
                </a>
                <a href="/supportTicket" style="text-decoration: none; color: black;">
                  <p>Support Ticket</p>
                </a>` : ''}
            </div>
            <div class="ourinfo">
              <p class="info">Our Information</p>
              <p>IIIT SriCity</p>
              <p>+91 0000000000</p>
              <p>Artisanspace09@gmail.com</p>
            </div>
          </div>
          <div class="bottomfooter">
            Copyright &copy; 2025 All Rights Reserved by ArtisanSpace
          </div>
        </footer>
      `;
    }

    function showNotification(message, type) {
      let notificationContainer = document.querySelector('.notification-container');
      if (!notificationContainer) {
        notificationContainer = document.createElement('div');
        notificationContainer.className = 'notification-container';
        document.body.appendChild(notificationContainer);
      }
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      notificationContainer.appendChild(notification);
      setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => notification.remove(), 500);
      }, 3000);
    }

    function wireButtons() {
      document.querySelectorAll('.accept-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const res = await fetch(`/artisan/workshops/accept/${id}`, { method: 'GET' });
          const data = await res.json();
          if (data.success) {
            showNotification('Workshop accepted successfully!', 'success');
            setTimeout(() => location.reload(), 500);
          } else {
            showNotification(data.message || 'Failed to accept workshop', 'error');
          }
        });
      });
      document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const res = await fetch(`/artisan/workshops/remove/${id}`, { method: 'GET' });
          const data = await res.json();
          if (data.success) {
            showNotification('Workshop removed successfully!', 'success');
            setTimeout(() => location.reload(), 500);
          } else {
            showNotification(data.message || 'Failed to remove workshop', 'error');
          }
        });
      });
    }

    (async function init() {
      // fetch user role to render navbar/footer appropriately
      const roleResp = await fetch('/api/user-role');
      const roleJson = roleResp.ok ? await roleResp.json() : { role: 'artisan' };
      const role = roleJson.role || 'artisan';

      document.getElementById('navbar-placeholder').innerHTML = createNavbar(role);
      document.getElementById('footer-placeholder').innerHTML = createFooter(role);

      const data = await fetchJson('/artisan/api/workshops');
      if (!data) {
        document.getElementById('available-loading').textContent = 'Failed to load workshops';
        document.getElementById('accepted-loading').textContent = 'Failed to load workshops';
        return;
      }

      const { availableWorkshops, acceptedWorkshops } = data;

      // Available
      const availableBody = document.getElementById('availableBody');
      if (availableWorkshops && availableWorkshops.length) {
        document.getElementById('available-loading').style.display = 'none';
        document.getElementById('availableTable').style.display = 'table';
        availableWorkshops.forEach(w => {
          const tr = document.createElement('tr');
          tr.dataset.id = w._id;
          tr.innerHTML = `
            <td><strong>${w.workshopTitle}</strong></td>
            <td class="workshop-description" title="${w.workshopDescription}">${w.workshopDescription}</td>
            <td>${w.userId?.username || 'N/A'}</td>
            <td>${w.date || ''}</td>
            <td>${w.time || ''}</td>
            <td><button class="accept-btn" data-id="${w._id}">Accept Workshop</button></td>
          `;
          availableBody.appendChild(tr);
        });
      } else {
        document.getElementById('available-loading').style.display = 'none';
      }

      // Accepted
      const acceptedBody = document.getElementById('acceptedBody');
      if (acceptedWorkshops && acceptedWorkshops.length) {
        document.getElementById('accepted-loading').style.display = 'none';
        document.getElementById('acceptedTable').style.display = 'table';
        acceptedWorkshops.forEach(w => {
          const tr = document.createElement('tr');
          tr.dataset.id = w._id;
          tr.innerHTML = `
            <td><span class="status-badge">Accepted</span></td>
            <td><strong>${w.workshopTitle}</strong></td>
            <td class="workshop-description" title="${w.workshopDescription}">${w.workshopDescription}</td>
            <td>
              <div>${w.userId?.username || ''}</div>
              <div><small>${w.userId?.email || ''}</small></div>
              <div><small>${w.userId?.mobile_no || ''}</small></div>
            </td>
            <td>
              <div>${w.date || ''}</div>
              <div>${w.time || ''}</div>
            </td>
            <td>${w.acceptedAt ? new Date(w.acceptedAt).toLocaleDateString() : ''}</td>
            <td><button class="remove-btn" data-id="${w._id}">Remove Workshop</button></td>
          `;
          acceptedBody.appendChild(tr);
        });
      } else {
        document.getElementById('accepted-loading').style.display = 'none';
      }

      wireButtons();

      // notification styles
      const style = document.createElement('style');
      style.textContent = `
        .notification-container { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .notification { padding: 12px 20px; margin-bottom: 10px; border-radius: 4px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slide-in 0.3s ease-out forwards; font-weight: 500; }
        .notification.success { background-color: #28a745; border-left: 4px solid #1e7e34; }
        .notification.error { background-color: #dc3545; border-left: 4px solid #bd2130; }
        .notification.fade-out { animation: fade-out 0.5s ease-out forwards; }
        @keyframes slide-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fade-out { from { transform: translateX(0); opacity: 1; } to { transform: translateX(20px); opacity: 0; } }
      `;
      document.head.appendChild(style);
    })();
  </script>
</body>

</html>
